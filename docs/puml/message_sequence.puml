@startuml Byte Flow
skinparam participantPadding 15
actor CLI            as U
participant "CLIÂ task\n(run_cli_loop)"          as CLI
participant "ConnectionManager\n(write_bytes)" as CM
participant "write_stop_tx\n(Sender)"          as CtrlTx
participant "I/O task\n(perâ€‘connection)"       as IO
participant "Transport\n(Serial / SSH)"        as TR
participant "Remote Connection"                      as REM

== Send keystroke ==
U  -> CLI   : press 'a'
CLI -> CM   : write_bytes(id, [97])
CM  -> CtrlTx : IoEvent::Write([97])
CtrlTx --> IO : (recv)
IO  -> TR   : write([97])
TR  -> REM   : write([97])

== Remote echoes ==
REM --> TR  : 'a'
TR --> IO   : conn.read() -> [97]
IO  -> U : broadcast_tx.send([97])
U  -> U   : write_all + flush

== Stop request (Ctrl+A x) ==
U  -> CLI   : Ctrl+A 'x'
CLI -> CM   : stop_connection(id)
CM  -> CtrlTx : IoEvent::Stop
CtrlTx --> IO : (recv)
IO  -> TR   : disconnect()
IO  --> CM  : task ends
@enduml
